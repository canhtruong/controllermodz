<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2006-2018 Magento, Inc. (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php 
	 
	$array_email = array();
	
	$om = \Magento\Framework\App\ObjectManager::getInstance();  
	$customerSession = $om->get('Magento\Customer\Model\Session');  
	
	$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
	
	$_orders = $objectManager->create('\Magento\Sales\Model\ResourceModel\Order\Collection');
    $_orders->addFieldToSelect("*")->addAttributeToFilter('customer_id', $customerSession->getId())->setOrder('created_at','desc');
    
	$_orders->setCurPage(1)->setPageSize(15);
	foreach ($_orders as $_order){
	    
		$item_data = array();
		$item_data['subject'] = 'New Order # '.$_order->getIncrementId();
		$timee = $_order->getCreatedAt();
		$timee = explode(" ", $timee);
		$item_data['date'] = DateTime::createFromFormat('Y-m-d', $timee[0])->format('m/d/Y');
		$item_data['url'] = 'notifications-detail?id='.$_order->getId();
		$item_data['is_shipment_invoice'] = '2';
		$item_data['order_id'] = $_order->getId();
		$array_email[strtotime($_order->getCreatedAt())] = $item_data;
		
		
		if(count($_order->getInvoiceCollection())>0){
			foreach($_order->getInvoiceCollection() as $invoice){
				$item_data = array();
				// $item_data['subject'] = 'Invoice # '.$invoice->getIncrementId().' for Order # '.$_order->getIncrementId();
				$item_data['subject'] = 'Invoice # '.$invoice->getIncrementId();

				$timee = $invoice->getCreatedAt();
				$timee = explode(" ", $timee);
				$item_data['date'] = DateTime::createFromFormat('Y-m-d', $timee[0])->format('m/d/Y');
				$item_data['url'] = $this->getUrl('invoice-detail?id='.$invoice->getId().'&order_id='.$_order->getId());
				$item_data['is_shipment_invoice'] = '1';
				$item_data['order_id'] = $_order->getId();
				$array_email[strtotime($invoice->getCreatedAt())] = $item_data;
			}			
		}
		if(count($_order->getShipmentsCollection())>0){
			foreach($_order->getShipmentsCollection() as $shipment){
				$item_data = array();
				// $item_data['subject'] = 'Shipment # '.$shipment->getIncrementId().' for Order # '.$_order->getIncrementId();
				$item_data['subject'] = 'Shipment # '.$shipment->getIncrementId();
				$timee = $shipment->getCreatedAt();
				$timee = explode(" ", $timee);
				$item_data['date'] = DateTime::createFromFormat('Y-m-d', $timee[0])->format('m/d/Y');
				$item_data['url'] = $this->getUrl('shipment-detail?id/'.$shipment->getId().'&order_id='.$_order->getId());				
				$item_data['is_shipment_invoice'] = '1';
				$item_data['order_id'] = $_order->getId();
				$array_email[strtotime($shipment->getCreatedAt())] = $item_data;
			}			
		}
	}
	
	
	krsort($array_email);
	
?>

<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<style type="text/css">
 .page-main > .page-title-wrapper .page-title {
    display: none;
}
.page-wrapper > .breadcrumbs{ max-width: 100%; }
.col2-left-layout .col-left.sidebar {
    padding-right: 12px;
    align-self: flex-start;
}
.sidebar .left_my_account {
    background: #000 none repeat scroll 0 0;
    padding: 20px;
    text-align: center;
}
.sidebar .left_my_account p.icon {
    margin-bottom: 20px;
}
.sidebar .left_my_account p.name {
    font-weight: 600;
}
.sidebar .left_my_account p {
    color: #ffffff;
    margin: 0;
}
.sidebar .block-account .block-content {
    background: rgba(0, 0, 0, 0) linear-gradient(to right, #196d39, #dff0d8) repeat scroll 0 0;
    padding-top: 20px;
}
.block-account ul li, .block.block-blog-categories .blog-category {
    padding: 8px 3px 8px 18px;
    position: relative;
    line-height: 1.3;
    border-bottom: 1px solid #ddd;
        border-bottom-color: rgb(221, 221, 221);
}
.sidebar .block-account .block-content li {
    border-color: #c99597;
    margin: 0 20px;
    padding: 5px 0;
}
.fa {
    display: inline-block;
    font-family: FontAwesome;
    font-style: normal;
    font-weight: normal;
    line-height: 1;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}
.sidebar .left_my_account .icon span {
    background: #afafc3 none repeat scroll 0 0;
    border: 2px solid #6b6db6;
    border-radius: 50%;
    display: inline-block;
    font-size: 42px;
    height: 65px;
    line-height: 60px;
    width: 65px;
}
.sidebar .block-account .block-content li a, .sidebar .block-account .block-content li strong {
    color: #ffffff;
    display: block;
    line-height: 29px;
    padding: 2px 0 2px 15px;
}
.block-account ul li, .block.block-blog-categories .blog-category {
    line-height: 1.3;
}
.sidebar .block-account .block-content li:last-child {
    border-bottom: 0 none;
}

#my-orders-table td {
  border: 1px solid #ccc;
}
#my-orders-table {
  border: 1px solid #ccc;
}
#my-orders-table th {
  background: #f6f6f6;
	text-transform: uppercase;
	color: #777;
}
</style>
<div class="col-left sidebar f-left col-lg-3" style="width:22.3% !important;float:left !important;padding: 0 22px 0 0 !important;">
    <div class="block block-account">
        <div class="left_my_account">
            <p class="icon"><span><i class="fa fa-user" aria-hidden="true"></i></span></p>
            <?php
                $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
                $customerSession = $objectManager->create('Magento\Customer\Model\Session'); 
            ?>
            <p class="name"><?php echo $customerSession->getCustomer()->getName();  ?></p>
            <p class="email"><?php echo $customerSession->getCustomer()->getEmail(); ?></p>
        </div>
        
        <div class="block-content">
            <ul style="padding: 0;list-style: none;">
                <li><a href="<?php echo $this->getBaseUrl() ?>customer/account/">Account Dashboard</a></li>
                <li><a href="<?php echo $this->getBaseUrl() ?>customer/account/edit/">Account Information</a></li>
                <li><a href="<?php echo $this->getBaseUrl() ?>sales/order/history/">My Orders</a></li>
                <li><a href="<?php echo $this->getBaseUrl() ?>emailorder/invoice/list/">My Invoices</a></li>
                <li><a href="<?php echo $this->getBaseUrl() ?>daily-on-hand-stock/">Daily On-Hand Stock</a></li>
                <li><a href="<?php echo $this->getBaseUrl() ?>suggested-order/">Suggested Order</a></li>
                <li><a href="<?php echo $this->getBaseUrl() ?>approved-release-confirmation/">Approved Releases</a></li>
                <li><a href="<?php echo $this->getBaseUrl() ?>receipt-confirmation/">Receipt Confirmation</a></li>
<li><a href="<?php echo $this->getBaseUrl() ?>customer-statement/">Customer Statement</a></li>
                <li><a href="<?php echo $this->getBaseUrl() ?>notifications/">Notifications</a></li>
                <li class="last"><a href="<?php echo $this->getBaseUrl() ?>customer/account/subAccount/">Manage Users</a></li>
            </ul>
        </div>
    </div>
</div>
<div style="width: 77.7%;float: left;">

<div class="box-account box-recent quotation">

	<div class="box-head">
        <h2><?php echo 'Notifications' ?></h2>
    </div>
<?php if( sizeof($array_email) > 0 ): ?>
    <table class="data-table" id="my-orders-table">
    <col width="1" />
    <col width="1" />
    <col width="1" />
        <thead>
            <tr>
                <th><?php echo 'Subject #' ?></th>
                <th><?php echo 'Date' ?></th> 
                <th><?php echo 'View' ?></th>
            </tr>
        </thead>
        <tbody>

            <?php foreach ($array_email as $item):?>
				
				
			
				<?php if($item['is_shipment_invoice']==0 || $item['is_shipment_invoice']==2){  ?>
					<tr>
						<td class="quote_id"><a href="<?php echo $item['url'] ?>" target="_blank" ><?php echo $item['subject'] ?></a></td>
						<td><span class="nobr"><?php echo $item['date'] ?></span></td>
						<td class="a-center">
							<span class="nobr">
								<a href="<?php echo $item['url'] ?>" target="_blank" ><?php echo 'View Email' ?></a>
							</span>
						</td>
					</tr>
					<?php if($item['is_shipment_invoice']==2){ ?>

						<?php foreach ($array_email as $item_shipment_invoice):?>
						
							<?php if($item_shipment_invoice['is_shipment_invoice']==1 && $item_shipment_invoice['order_id'] == $item['order_id'] ){   ?>
								<tr>
									<td class="quote_id"><a href="<?php echo $item_shipment_invoice['url'] ?>" target="_blank" ><?php echo $item_shipment_invoice['subject'] ?></a></td>
									<td><span class="nobr"><?php echo $item_shipment_invoice['date'] ?></span></td>
									<td class="a-center">
										<span class="nobr">
										<a href="<?php echo $item_shipment_invoice['url'] ?>" target="_blank" ><?php echo 'View Email' ?></a>
										</span>
									</td>
								</tr>
							<?php } ?>
						<?php endforeach; ?>
					<?php } ?>
				<?php } ?>
				
            <?php endforeach; ?>
        </tbody>
    </table>
    <script type="text/javascript">decorateTable('my-orders-table')</script>
<?php else: ?>
    <p>You have placed no orders.</p>
<?php endif; ?>
</div>
</div>
